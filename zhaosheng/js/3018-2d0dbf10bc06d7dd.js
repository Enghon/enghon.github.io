try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="a861e387-752f-4c14-9eef-1039a832a7e6",e._sentryDebugIdIdentifier="sentry-dbid-a861e387-752f-4c14-9eef-1039a832a7e6")}catch(e){}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3018],{39858:function(e,t,s){async function r(e,t){let s;let r=e.getReader();for(;!(s=await r.read()).done;)t(s.value)}function a(){return{data:"",event:"",id:"",retry:void 0}}s.r(t),s.d(t,{EventStreamContentType:function(){return i},fetchEventSource:function(){return c}});var n=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&0>t.indexOf(r)&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)0>t.indexOf(r[a])&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s};let i="text/event-stream",o="last-event-id";function c(e,t){var{signal:s,headers:c,onopen:h,onmessage:d,onclose:u,onerror:p,openWhenHidden:g,fetch:f}=t,v=n(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((t,n)=>{let y;let _=Object.assign({},c);function b(){y.abort(),document.hidden||D()}_.accept||(_.accept=i),g||document.addEventListener("visibilitychange",b);let m=1e3,w=0;function S(){document.removeEventListener("visibilitychange",b),window.clearTimeout(w),y.abort()}null==s||s.addEventListener("abort",()=>{S(),t()});let O=null!=f?f:window.fetch,E=null!=h?h:l;async function D(){var s,i;y=new AbortController;try{let s,n,c,l;let h=await O(e,Object.assign(Object.assign({},v),{headers:_,signal:y.signal}));await E(h),await r(h.body,(i=function(e,t,s){let r=a(),n=new TextDecoder;return function(i,o){if(0===i.length)null==s||s(r),r=a();else if(o>0){let s=n.decode(i.subarray(0,o)),a=o+(32===i[o+1]?2:1),c=n.decode(i.subarray(a));switch(s){case"data":r.data=r.data?r.data+"\n"+c:c;break;case"event":r.event=c;break;case"id":e(r.id=c);break;case"retry":let l=parseInt(c,10);isNaN(l)||t(r.retry=l)}}}}(e=>{e?_[o]=e:delete _[o]},e=>{m=e},d),l=!1,function(e){void 0===s?(s=e,n=0,c=-1):s=function(e,t){let s=new Uint8Array(e.length+t.length);return s.set(e),s.set(t,e.length),s}(s,e);let t=s.length,r=0;for(;n<t;){l&&(10===s[n]&&(r=++n),l=!1);let e=-1;for(;n<t&&-1===e;++n)switch(s[n]){case 58:-1===c&&(c=n-r);break;case 13:l=!0;case 10:e=n}if(-1===e)break;i(s.subarray(r,e),c),r=n,c=-1}r===t?s=void 0:0!==r&&(s=s.subarray(r),n-=r)})),null==u||u(),S(),t()}catch(e){if(!y.signal.aborted)try{let t=null!==(s=null==p?void 0:p(e))&&void 0!==s?s:m;window.clearTimeout(w),w=window.setTimeout(D,t)}catch(e){S(),n(e)}}}D()})}function l(e){let t=e.headers.get("content-type");if(!(null==t?void 0:t.startsWith(i)))throw Error(`Expected content-type to be ${i}, Actual: ${t}`)}},33018:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);(!a||("get"in a?!t.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return a(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.SseController=t.NEW_SENTENCE_ID=void 0;let i=n(s(5532));t.SseController=i.default,Object.defineProperty(t,"NEW_SENTENCE_ID",{enumerable:!0,get:function(){return i.NEW_SENTENCE_ID}})},5532:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))(function(a,n){function i(e){try{c(r.next(e))}catch(e){n(e)}}function o(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,o)}c((r=r.apply(e,t||[])).next())})},a=this&&this.__rest||function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&0>t.indexOf(r)&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)0>t.indexOf(r[a])&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s};Object.defineProperty(t,"__esModule",{value:!0}),t.NEW_SENTENCE_ID=t.DEFAULT_CONVERSATION_ID=void 0;let n=s(39858),i=s(34559),o=s(73661),c={content:{botId:-1,breakingStrategy:0,contents:"",conversationId:"",isBanned:!1,isRetry:"retry",sentenceId:"",turnId:"",userId:-1},type:"message"};t.DEFAULT_CONVERSATION_ID="00000000-0000-0000-0000-000000000000";let l="抱歉，网络开小差了，请再问我一次。",h={SUCCESS:"0"};t.NEW_SENTENCE_ID="NEW_SENTENCE_ID";class d{constructor({auth:e,visitorId:t,baseUrl:s,commonHeaders:r,timeout:a,eventSource:n,control:o}){if(!s)throw Error();this.auth=e,this.visitorId=t,this.baseUrl=s,this.timeout=a||30,this.addComHeaders=(0,i.addCommonHeaders)(r),this.sseGather={},this.callBacks={},this.conversationGather={},this.eventSource=n,this.control=o}setAuth(e){this.auth=e}setVisitorId(e){this.visitorId=e}bind(e,t){let s=this.callBacks[e];return Array.isArray(s)?s.push(t):this.callBacks[e]=[t],()=>{let s=this.callBacks[e];if(Array.isArray(s))for(let e=0;e<s.length;++e)s[e]===t&&s.splice(e,1)}}sseUrl(e){let{baseUrl:t}=this;return(e||[]).indexOf("deep_research")>-1?`${t}/conversation/chat/v2`:`${t}/conversation/chat/v1`}sendMsgToBot(e){return r(this,void 0,void 0,function*(){yield this._beforeOpen(e),yield this.buildSSe(e)})}buildSSe({botId:e,botAlias:t,contents:s,strategy:a,conversationId:i,uuid:c,turnId:h,querySentenceId:d,attachments:u,attachmentInfo:p,inputWay:g,mediaInfos:f,turnIndex:v,rewriteQuery:y,isNewConversation:_=!1,answerSentenceId:b,customParams:m={}}){return new Promise((w,S)=>{let O=this.sseGather[c];if(!O){let{breakingStrategy:w,isRetry:S}=a||{},O=((null==m?void 0:m.capabilities)||[]).map(e=>e.key),E=this.sseUrl(O),D=Array.isArray(f)?f.map(e=>({fileMd5:e.fileMd5,fileId:e.fileId})):[],{visitorId:A}=this,{token:G,user:I}=this.auth,N=this.control?new this.control:new AbortController,k={method:"POST",headers:{"X-Yuanshi-Authorization":`Bearer ${G}`,"X-Yuanshi-DeviceId":A,"Content-type":"application/json",Accept:"text/event-stream, application/json",Connection:"keep-alive"},data:{userId:null==I?void 0:I.id,botId:e,botAlias:t,query:s,isRetry:S,breakingStrategy:w,isNewConversation:_,mediaInfos:D,turnIndex:v,rewriteQuery:y,conversationId:i,querySentenceId:d,answerSentenceId:b,turnId:h}},j=setTimeout(this.handleTimeout.bind(this,{conversationId:i,uuid:i,botId:e}),1e3*this.timeout);u&&(k.data.attachments=u),p&&(k.data.attachmentInfo=p),g&&(k.data.inputWay=g),S&&(k.data.turnId=h),k.data=Object.assign(Object.assign({},k.data),m),this.addComHeaders(k),(0,o.signFn)(k);let C=this.eventSource||n.fetchEventSource,B=C(E,{openWhenHidden:!0,method:k.method,headers:k.headers,signal:N.signal,body:JSON.stringify(k.data),onopen:t=>r(this,void 0,void 0,function*(){if(!t.ok||"text/event-stream"!==t.headers.get("content-type")){if(t.ok&&t.headers.get("content-type")&&t.headers.get("content-type").includes("application/json")){clearTimeout(j);let r=yield t.json(),{code:n=-999,msg:o=l}=r;this._onError({botId:e,strategy:a,event:{event:"error1",data:JSON.stringify({code:n,message:o})},contents:s,conversationId:i,uuid:c}),N.abort();return}if(t.status>=400&&t.status<500&&429!==t.status){this._onError({botId:e,strategy:a,event:{event:"error2",data:JSON.stringify({code:t.status,content:l})},contents:s,conversationId:i,uuid:c}),N.abort();return}this._onError({botId:e,strategy:a,event:{event:"error3",data:JSON.stringify({code:t.status,content:l})},contents:s,conversationId:i,uuid:c}),N.abort();return}}),onmessage:t=>r(this,void 0,void 0,function*(){var r;if(!this.sseGather[c])return;switch(Array.isArray(this.sseGather[c].timestamp[t.event])?this.sseGather[c].timestamp[t.event].push(Date.now()):this.sseGather[c].timestamp[t.event]=Date.now(),t.event){case"opened":clearTimeout(j),this._onOpen({botId:e,strategy:a,event:t,contents:s,conversationId:i,uuid:c});break;case"loading":this._onLoading({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"message":this._onMessage({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"generateEnd":this._generateEnd({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"suggestedQuestions":case"suggestionR1":this._onSuggested({botId:e,event:t,strategy:a,conversationId:i,uuid:c});break;case"suggestionReco":this._onSuggestedReco({botId:e,event:t,strategy:a,conversationId:i,uuid:c});break;case"webSearch":this._onWebSearch({botId:e,event:t,strategy:a,conversationId:i,uuid:c});break;case"webSearchDetail":this._onWebSearchDetail({botId:e,event:t,strategy:a,conversationId:i,uuid:c});break;case"error":yield this._onError({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"banned":this._onBanned({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"close":yield this._onMsgEnd({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"cards":this._onCards({event:t,botId:e,strategy:a,conversationId:i,uuid:c});return;case"ppt":this._onPpt({event:t,botId:e,strategy:a,conversationId:i,uuid:c});return;case"deepResearch":this._onDeepResearch({event:t,botId:e,strategy:a,conversationId:i,uuid:c});return;case"onlineSearch":this._onOnlineSearch({event:t,botId:e,strategy:a,conversationId:i,uuid:c});return;case"answerVisualization":this._onAnswerVisualization({event:t,botId:e,strategy:a,conversationId:i,uuid:c});break;case"visualizationError":this._onVisualizationError({event:t,botId:e,strategy:a,conversationId:i,uuid:c})}let n=this.callBacks.trunk,o=this.conversationGather[c];if(Array.isArray(n))for(let s=0;s<n.length;++s)n[s]({event:t,botId:e,strategy:a,conversationId:i,conver:o,timestamp:null===(r=this.sseGather[c])||void 0===r?void 0:r.timestamp,uuid:c,responseData:t.data});("close"===t.event||"error"===t.event)&&this._distroySse({botId:e,conversationId:i,uuid:c})}),onclose(){},onerror:t=>{throw console.log(t),this._onError({botId:e,strategy:a,event:{event:"erro4r",data:JSON.stringify({code:-998,content:l})},contents:s,conversationId:i,uuid:c}),this._distroySse({botId:e,conversationId:i,uuid:c}),t}});this.sseGather[c]={source:B,botId:e,conversationId:i,strategy:a,contents:s,uuid:c,ctrl:N,timestamp:{build:Date.now(),message:[],suggestedQuestions:[]},state:0,sseRetryCount:2}}})}stopSse({botId:e,conversationId:s,uuid:a,callback:n,fail:i,defaultData:o}){return r(this,void 0,void 0,function*(){let r=this.sseGather[a];if(r){let i=this.conversationGather[a],{strategy:o,contents:l}=r;0===this.sseGather[a].state&&(this.sseGather[a].state=-1);let h=i.answer?Object.assign(Object.assign({},i.answer),{voluntaryStop:!0}):{conversationId:s,answerSentenceId:`${t.NEW_SENTENCE_ID}_${Date.now()}`,turnId:i.turnId,content:"",voluntaryStop:!0};this._insertAnswer({responseData:h,botId:e,conversationId:s,uuid:a}),yield this._onMsgEnd({event:{data:Object.assign(Object.assign({},c),{conversationId:s})},botId:e,strategy:o,conversationId:s,uuid:a}),this._distroySse({botId:e,conversationId:s,uuid:a}),n&&n({botId:e,conver:i,strategy:o,conversationId:s,uuid:a})}else i?i():n&&n({botId:e,conver:o,strategy:{isRetry:!1,breakingStrategy:0},conversationId:s,uuid:a})})}handleTimeout({botId:e,conversationId:t,uuid:s,callback:a}){return r(this,void 0,void 0,function*(){let r=this.sseGather[s];if(r){this.conversationGather[s];let{botId:e,strategy:a,contents:n}=r;this._onError({botId:e,strategy:a,event:{event:"error5",data:JSON.stringify({code:-999,content:l})},contents:n,conversationId:t,uuid:s})}this._distroySse({botId:e,conversationId:t,uuid:s})})}_insertAnswer({botId:e,responseData:s,strategy:r,conversationId:n,uuid:i}){let o=this.conversationGather[i],{content:c,answerSentenceId:l,voluntaryStop:h}=s,d=a(s,["content","answerSentenceId","voluntaryStop"]);if(o){if(o.answer&&o.answer.isBanned)return;if(o.answer&&o.answer.sentenceId!==t.NEW_SENTENCE_ID){let e=o.answer.contents+(c||"");o.answer=Object.assign(Object.assign(Object.assign({},d),o.answer),{contents:e,voluntaryStop:h})}else o.answer=Object.assign(Object.assign({},d),{conversationId:s.conversationId||n,sentenceId:l,contents:c,turnId:s.turnId||o.turnId,voluntaryStop:h})}}_replaceAnswer({botId:e,responseData:t,conversationId:s,uuid:r}){let a=this.conversationGather[r],{content:n}=t;a&&(a.answer?a.answer=Object.assign(Object.assign({},a.answer),{contents:n}):n.conversationId?a.answer=n:a.answer=Object.assign(Object.assign({},a.question),{contents:n}))}_insertQuestion({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let{isRetry:n,breakingStrategy:i}=s,o=this.conversationGather[a];o&&(o.conversationId=t.conversationId||r,o.turnId=t.turnId,n||(o.question.sentenceId=t.querySentenceId))}_insertSuggested({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(Array.isArray(n.suggested)?n.suggested.push(t.content):n.suggested=[t.content])}_insertSuggestedReco({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(Array.isArray(n.suggestedReco)?n.suggestedReco.push(t.content):n.suggestedReco=[t.content])}_insertLoading({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.loadingEvent={status:!0,content:t.content},n.answer&&(n.answer=Object.assign(Object.assign({},n.answer),{loadingEvent:{status:!0,content:t.content}})))}_closeLoading({botId:e,conversationId:t,uuid:s}){let r=this.conversationGather[s];r&&r.loadingEvent&&(r.loadingEvent.status=!1,r.answer&&r.answer.loadingEvent&&(r.answer.loadingEvent.status=!1))}_insertWebSearch({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.webSearch=t)}_insertWebSearchDetail({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.webSearchDetail=t)}_insertCards({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.cards=t)}_insertBanned({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&n.answer&&(n.answer.isBanned=!0)}_insertPpt({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.ppt=t)}_insertDeepResearch({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.deepResearch=t)}_insertOnlineSearch({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&(n.onlineSearch=t)}_insertAnswerVisualization({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&n.answer&&(n.answer.answerVisualization=t.content)}_insertVisualizationError({botId:e,responseData:t,strategy:s,conversationId:r,uuid:a}){let n=this.conversationGather[a];n&&n.answer&&(n.answer.visualizationError=t.content)}_beforeOpen(e){return r(this,void 0,void 0,function*(){let{botId:s,conversationId:r,contents:a,strategy:n,uuid:i,turnId:o,querySentenceId:c,customAttrs:l,timeoutRetry:h,mediaInfos:d,turnIndex:u,rewriteQuery:p,isNewConversation:g=!1,customParams:f={},answerSentenceId:v}=e,y=this.conversationGather[i];if(!y){let e=new Date,p=o||`newTurnId_${Date.now()}`;this.conversationGather[i]={conversationId:r,turnId:p,question:{contents:a,direction:1,sentTime:e,sentenceId:c||t.NEW_SENTENCE_ID,state:0,mediaInfos:d,turnIndex:u,extraInfo2:{chatReqSnapshot:Object.assign({},f)}},timeoutRetry:h,customAttrs:l,isNewConversation:g},this.conversationGather[i].answer={conversationId:r,turnId:p,direction:2,sentenceId:v||t.NEW_SENTENCE_ID,state:0,contents:""},console.log("in package/sse.ts _beforeOpen",this.conversationGather[i]);let y=this.callBacks.beforeOpen;if(Array.isArray(y)){let e=y.map(e=>new Promise(t=>{e({botId:s,conversationId:r,conver:this.conversationGather[i],strategy:n,onComplete:t,uuid:i})}));yield Promise.all(e)}}})}_onOpen({event:e,botId:t,strategy:s,contents:r,conversationId:a,uuid:n}){try{let r=JSON.parse(e.data);r.content="",this._insertQuestion({responseData:r,botId:t,strategy:s,conversationId:a,uuid:n}),this._insertAnswer({responseData:r,botId:t,conversationId:a,uuid:n});let i=this.callBacks.open,o=this.conversationGather[n];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:a,uuid:n,responseData:r})}catch(e){}}_onLoading({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertLoading({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.loading,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,responseData:n})}catch(e){console.error(e)}}_onMessage({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertAnswer({responseData:n,botId:t,conversationId:r,uuid:a}),this._closeLoading({botId:t,conversationId:r,uuid:a});let i=this.callBacks.message,o=this.conversationGather[a],c=this.sseGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:n})}catch(e){console.error(e)}}_generateEnd({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=this.conversationGather[a],i=JSON.parse(e.data);n&&n.answer&&(n.answer.end=!0);let o=this.callBacks.generateEnd,c=this.sseGather[a];if(Array.isArray(o))for(let e=0;e<o.length;++e)o[e]({botId:t,conver:n,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:i})}catch(e){console.error(e)}}_onMsgEnd({event:e,botId:t,strategy:s,conversationId:a,uuid:n}){return r(this,void 0,void 0,function*(){try{let e=this.conversationGather[n],r=this.sseGather[n];if(!e||!r)return;0===r.state&&(r.state=h.SUCCESS);let i=this.callBacks.end;if(Array.isArray(i))for(let o=0;o<i.length;++o)i[o]({botId:t,conver:e,strategy:s,conversationId:a,uuid:n,timestamp:r.timestamp,state:r.state})}catch(e){console.error(e)}})}_onCards({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertCards({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.cards,o=this.conversationGather[a],c=this.sseGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state})}catch(e){console.error(e)}}_onDeepResearch({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertDeepResearch({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.deepResearch,o=this.conversationGather[a],c=this.sseGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:n})}catch(e){console.error(e)}}_onOnlineSearch({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertOnlineSearch({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.onlineSearch,o=this.conversationGather[a],c=this.sseGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:n})}catch(e){console.error(e)}}_onPpt({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertPpt({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.ppt,o=this.conversationGather[a],c=this.sseGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:n})}catch(e){console.error(e)}}_onBanned({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){var n;try{let i=JSON.parse(e.data);this.sseGather[a].state=i.code,this._replaceAnswer({responseData:i,botId:t,conversationId:r,uuid:a}),this._insertBanned({responseData:i,botId:t,conversationId:r,uuid:a});let o=this.callBacks.banned,c=this.sseGather[a],l=this.conversationGather[a];if(Array.isArray(o))for(let e=0;e<o.length;++e)o[e]({botId:t,conver:l,strategy:s,conversationId:r,uuid:a,timestamp:c.timestamp,state:c.state,responseData:i});c&&(null===(n=c.ctrl)||void 0===n||n.abort())}catch(e){console.error(e)}}_onError({event:e,botId:t,strategy:s,conversationId:a,uuid:n}){return r(this,void 0,void 0,function*(){let r={};try{r=JSON.parse(e.data)}catch(e){r={code:-999,message:(null==e?void 0:e.message)||"未知错误"},console.error(e)}-999!==r.code&&(r.message?r.content=r.message:r.content=l,this._replaceAnswer({responseData:r,botId:t,conversationId:a,uuid:n})),this.sseGather[n].state=r.code,this.sseGather[n].errorMessage=r.message;let i=this.conversationGather[n],o=this.sseGather[n],c=this.callBacks.error;if(Array.isArray(c)){let l=c.map(c=>new Promise(l=>{c({botId:t,conver:i,strategy:s,conversationId:a,onComplete:l,uuid:n,timestamp:o.timestamp,state:o.state,errorMessage:o.errorMessage,errorEvent:(null==e?void 0:e.event)||"nothing",responseData:r})}));yield Promise.all(l)}})}_onSuggested({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertSuggested({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.suggestedQuestions,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,responseData:n})}catch(e){console.error(e)}}_onSuggestedReco({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertSuggestedReco({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.suggestionReco,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,responseData:n})}catch(e){console.error(e)}}_onWebSearch({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let r=JSON.parse(e.data);this._insertWebSearch({responseData:r,botId:t,uuid:a});let n=this.callBacks.webSearch,i=this.conversationGather[a];if(Array.isArray(n))for(let e=0;e<n.length;++e)n[e]({botId:t,conver:i,strategy:s,uuid:a,responseData:r})}catch(e){console.error(e)}}_onWebSearchDetail({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let r=JSON.parse(e.data),{content:n}=r;this._insertWebSearchDetail({responseData:n,botId:t,uuid:a});let i=this.callBacks.webSearchDetail,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,uuid:a,responseData:r})}catch(e){console.error(e)}}_onAnswerVisualization({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertAnswerVisualization({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.answerVisualization,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,responseData:n})}catch(e){console.error(e)}}_onVisualizationError({event:e,botId:t,strategy:s,conversationId:r,uuid:a}){try{let n=JSON.parse(e.data);this._insertVisualizationError({responseData:n,botId:t,conversationId:r,uuid:a});let i=this.callBacks.answerVisualization,o=this.conversationGather[a];if(Array.isArray(i))for(let e=0;e<i.length;++e)i[e]({botId:t,conver:o,strategy:s,conversationId:r,uuid:a,responseData:n})}catch(e){console.error(e)}}_distroySse({botId:e,conversationId:t,uuid:s}){this.conversationGather[s]=null;let r=this.sseGather[s];if(r){let{ctrl:e}=r;e.abort()}this.sseGather[s]=null}}t.default=d}}]);
//# sourceMappingURL=3018-2d0dbf10bc06d7dd.js.map